# Set the language to Ruby so that we can run sass-spec tests.
language: ruby
env:
# Language specs, defined in sass/sass-spec
- TASK=specs DART_VERSION=latest
- TASK=specs DART_VERSION=1.20.1
- TASK=specs DART_VERSION=1.19.1

# Unit tests, defined in test/.
- TASK=tests DART_VERSION=latest
- TASK=tests DART_VERSION=1.20.1
- TASK=tests DART_VERSION=1.19.1
- TASK=tests DART_VERSION=latest NODE_VERSION=stable
- TASK=tests DART_VERSION=latest NODE_VERSION=v6.9.1
- TASK=tests DART_VERSION=latest NODE_VERSION=v4.6.2

# Miscellaneous checks.
- TASK=analyze DART_VERSION=latest
- TASK=format DART_VERSION=latest

rvm:
- 2.3.1

# Only run a single job for OS X. Travis has a long backlog for OS X builds, so
# we want to be as conservative as possible.
matrix:
  include:
    - os: osx
      env: NODE_VERSION=stable

  # We don't really want to allow OS X failures, but the builder backlog is long
  # enough that we can't afford to wait for it to finish.
  allow_failures: {os: osx}

# Only building master means that we don't run two builds for each pull request.
branches:
  only: [master]

cache:
  directories:
  - $HOME/.pub-cache

install:
# Install the Dart SDK.
- if [ "$TRAVIS_OS_NAME" = linux ]; then dart_os_name=linux; else dart_os_name=macos; fi
- curl -o dart.zip "https://storage.googleapis.com/dart-archive/channels/stable/release/$DART_VERSION/sdk/dartsdk-$dart_os_name-x64-release.zip"
- unzip dart.zip
- export PATH="$PATH:`pwd`/dart-sdk/bin"
- pub get

# Install the Node SDK if we're running Node tests.
- if-node() { if [ ! -z "$NODE_VERSION" ]; then "$@"; fi }
- if-node . "$HOME/.nvm/nvm.sh"
- if-node nvm install "$NODE_VERSION"
- if-node nvm use "$NODE_VERSION"
- if-node nvm install

# Download sass-spec and install its dependencies if we're running specs.
- if-specs() { if [ "$TASK" = specs -o "$TRAVIS_OS_NAME" = osx ]; then "$@"; fi }
- if-specs export sass_spec_ref=`tool/sass-spec-ref.sh`
- if-specs git init sass-spec
- if-specs git -C sass-spec fetch git://github.com/sass/sass-spec "$sass_spec_ref" --depth 1
- if-specs git -C sass-spec checkout FETCH_HEAD
- if-specs bundle install --gemfile=sass-spec/Gemfile --jobs=3 --retry=3

script: tool/travis.sh
